#!/bin/bash -e
##########################################################################
#                                                                        #
#  Copyright (C) 2004-2011 INTERSEC SAS                                  #
#                                                                        #
#  Should you receive a copy of this source code, you must check you     #
#  have a proper, written authorization of INTERSEC to hold it. If you   #
#  don't have such an authorization, you must DELETE all source code     #
#  files in your possession, and inform INTERSEC of the fact you obtain  #
#  these files. Should you not comply to these terms, you can be         #
#  prosecuted in the extent permitted by applicable law.                 #
#                                                                        #
##########################################################################

missing_dep=
profile=
out=/dev/stdout

# {{{ library

log_() {
    echo 2>&1 "$@"
}

die() {
    log_ '/!\' "$@" '/!\'
    exit 1
}

log() {
    log_ "..." "$@"
}

warn() {
    log_ "***" "$@"
    missing_dep=t
}

setenv() {
    v="$1"
    shift
    echo "export $v" "=" "$@" >> "$out"
}

setvar() {
    v="$1"
    shift
    echo "$v" "=" "$@" >> "$out"
}

check_tool() {
    which "$1" >/dev/null 2>&1 || warn "$1 is missing, apt-get install $2"
}

pkg_config_setvar() {
    pfx="$1"; shift
    deb="$1"; shift

    while test $# != 0; do
        pkg="$1"
        if pkg-config --print-errors "$pkg"; then
            setvar "${pfx}_CFLAGS" "$(pkg-config --cflags "$pkg")"
            setvar "${pfx}_LIBS"   "$(pkg-config --libs "$pkg")"
            return 0
        fi
        shift
    done
    warn "$deb is missing (apt-get install $deb)"
}

prereq() {
    want="$1"
    has="$2"

    test "$want" = "$has" && return 0
    while test -n "$want"; do
        test -z "$has" && return 1
        w="${want%%.*}"
        h="${has%%.*}"
        case "$want" in *.*) want="${want#*.}";; *) want=""; esac
        case "$has" in *.*)  has="${has#*.}";;   *) has=""; esac

        test "$w" -lt "$h" && return 0
        test "$w" -gt "$h" && return 1
    done

    return 0
}

# }}}

while test $# != 0; do
    case "$1" in
        -p)
            shift
            test $# != 0 || die "missing -p argument"
            profile="$1"
            shift
            ;;
        -o)
            shift
            test $# != 0 || die "missing -o argument"
            out="$1"
            shift
            ;;
        *) die "unknown argument $1";;
    esac
done

log "start configure"
test -n "$out" -a "$out" != "/dev/stdout" && rm -f "$out"


if test -n "$profile" -a -d /opt/intersec/${profile}; then
    export BUILDFOR_PREFIX="/opt/intersec/${profile}"
    export PKG_CONFIG_LIBDIR="${BUILDFOR_PREFIX}/usr/lib/pkgconfig"
    export PKG_CONFIG_LIBDIR="/usr/lib64/pkgconfig:${PKG_CONFIG_LIBDIR}"
    export PKG_CONFIG_ALLOW_SYSTEM_CFLAGS=1
    export PKG_CONFIG_ALLOW_SYSTEM_LIBS=1
else
    export PKG_CONFIG_LIBDIR="/usr/local/lib/pkgconfig:/usr/lib/pkgconfig"
    export PKG_CONFIG_LIBDIR="/usr/lib64/pkgconfig:${PKG_CONFIG_LIBDIR}"
    if test "$(uname -s)" = "SunOS"; then
        export PKG_CONFIG_LIBDIR="/opt/csw/lib/pkgconfig:${PKG_CONFIG_LIBDIR}"
    fi
fi

# {{{ tools

IOPC_VER=1.2.2
if ! prereq "$IOPC_VER" "$(iopc --version)"; then
    warn "iopc version $IOPC_VER required (update your tools.git + make -C ~/dev/tools/iopc install)"
fi

for tool in flex gperf mtasc swfmill xsltproc; do
    check_tool $tool $tool
done

if ! test -f /usr/include/sys/capability.h; then
    warn "mising libcap-dev (for <sys/capability.h>)"
fi

# }}}
# {{{ pkg-config packages

pkg_config_setvar "libxml2" "libxml2-dev"    "libxml-2.0"
pkg_config_setvar "lua"     "liblua5.1-dev"  "lua5.1" "lua"
pkg_config_setvar "zlib"    "zlib1g-dev"     "zlib"
pkg_config_setvar "sqlite"  "libsqlite3-dev" "sqlite3"

check_tool luac lua5.1

pkg_config_setvar "fuse" "libfuse-dev" "fuse"

# }}}
# {{{ libv8-dev

if test -r /usr/include/v8.h; then
    setenv "WITH_V8" "1"
    setvar "v8_CFLAGS"
    setvar "v8_LIBS" "-lv8"
else
    log "You are missing libv8, apt-get install libv8-dev"
fi

# }}}
# {{{ libpcap-dev

if test -r /usr/include/pcap.h; then
    setvar "libpcap_CFLAGS"
    setvar "libpcap_LIBS" "-lpcap"
else
    warn "missing libpcap, apt-get install libpcap-dev"
fi

# }}}
# {{{ libreadline-dev

if test -r /usr/lib/libreadline.so -o /usr/lib64/libreadline.so; then
    setvar "readline_CFLAGS"
    setvar "readline_LIBS" "-lreadline"
else
    warn "missing libreadline, apt-get install libreadline-dev"
fi

# }}}
# {{{ libsctp-dev

test -r /usr/include/netinet/sctp.h || warn "missing libsctp, apt-get install libsctp-dev"

# }}}
# {{{ ffmpeg

if pkg-config --print-errors "libavformat libavcodec"; then
    setvar "ffmpeg_CFLAGS" "$(pkg-config --cflags libavformat libavcodec)"
    setvar "ffmpeg_LIBS" "$(pkg-config --libs  libavformat libavcodec)"
fi

# }}}
# {{{ JNI

if test -z ${JAVA_HOME}; then
    warn "*** JAVA_HOME not set, JNI disabled"
else
    setvar "jni_CFLAGS" "-I${JAVA_HOME}/include -I${JAVA_HOME}/include/linux"
fi

# }}}
# {{{ JNI

if test -z ${JAVA_HOME}; then
    JAVA_HOME=$(ls -1 -d /usr/lib/jvm/java*sun*/include 2>/dev/null | head -1)
    JAVA_HOME=${JAVA_HOME%/*}
fi
if test -z ${JAVA_HOME}; then
    JAVA_HOME=$(ls -1 -d /usr/lib/jvm/java*/include 2>/dev/null | head -1)
    JAVA_HOME=${JAVA_HOME%/*}
fi
if test -z ${JAVA_HOME}; then
    JAVA_HOME=$(ls -1 -d /usr/java/*/include 2>/dev/null | head -1)
    JAVA_HOME=${JAVA_HOME%/*}
fi
if test -z ${JAVA_HOME}; then
    log "JAVA_HOME not set, JNI disabled"
else
    setenv "WITH_JNI" "1"
    setvar "jni_CFLAGS" "-I${JAVA_HOME}/include -I${JAVA_HOME}/include/linux"
    if test -d ${JAVA_HOME}/jre/lib/i386/server; then
        # -ljsig to use signal chaining of the JVM
        setvar "jvm_LDFLAGS" "-L${JAVA_HOME}/jre/lib/i386/server -Wl,--rpath=${JAVA_HOME}/jre/lib/i386/server:/usr/java/default/lib/i386i/server -ljvm -ljsig"
    elif test -d ${JAVA_HOME}/jre/lib/amd64/server; then
        setvar "jvm_LDFLAGS" "-L${JAVA_HOME}/jre/lib/amd64/server -Wl,--rpath=${JAVA_HOME}/jre/lib/amd64/server:/usr/java/default/lib/amd64/server -ljvm -ljsig"
    else
         warn "missing libjvm, apt-get install sun-java6-bin"
    fi
fi

# }}}
# {{{ Kit SIMPA SFR

simpa0="/home/data/projects/kiosque/Doc confidentiel SFR pour NSN 30102009/SIMPA_Kit Marchand_Java_V5.20.02_20091029.zip"
simpa1="/opt/kitmarchand"

file_exists() {
    test -e "$1" -a -r "$1"
}

if file_exists "$simpa1"; then
    setenv "ENABLE_SFR_SIMPA" "1"
    setenv "WITH_SFR_SIMPA" "1"
else
    setenv "ENABLE_SFR_SIMPA" "0"
    if test -r "$simpa0"; then
        log "kit SIMPA SFR not found (see $simpa0)"
    else
        log "kit SIMPA SFR not found"
    fi
fi

# }}}
# {{{ CCN SDK

ccn0="/home/data/build/ccn"
ccn1="/opt/ccn"

if file_exists "$ccn0" || file_exists "$ccn1"; then
    setenv "ENABLE_CCN" "1"
    setenv "WITH_CCN" "1"
else
    setenv "ENABLE_CCN" "0"
    log "CCN SDK not found"
fi

# }}}
# {{{ php

if test -z "${PHP_VERSION}"; then
    case "$profile" in
        platon)
        PHP_CONFIG=/opt/php-5.1.1/bin/php-config
        ;;
        solaris*)
        PHP_CONFIG=/usr/local/php/bin/php-config
        ;;
        *)
        if which php-config >/dev/null 2>/dev/null; then
            PHP_CONFIG=php-config
        else
            warn "php-config is missing, apt-get install php5-dev"
        fi
        ;;
    esac
else
    PHP_CONFIG=/opt/php-${PHP_VERSION}/bin/php-config
fi
if test -n "$PHP_CONFIG"; then
    setvar "php5_CFLAGS" "$("$PHP_CONFIG" --includes)"
fi

# }}}
# {{{ mysql

if which mysql_config 1>/dev/null 2>/dev/null; then
    setvar "mysqlclient_CFLAGS" "$(mysql_config --include)"
    setvar "mysqlclient_LIBS"   "$(mysql_config --libs | sed -e 's/-rdynamic//g')"
else
    warn "libmysqlclient-dev is missing, apt-get install libmysqlclient-dev"
fi

# }}}
# {{{ goes

if which geos-config 1>/dev/null 2>/dev/null; then
    setvar "geos_CFLAGS" "$(geos-config --cflags)"
    setvar "geos_LIBS"   "$(geos-config --libs|sed -e 's/-lgeos/-lgeos_c/g')"
else
    warn "libgeos-dev is missing, apt-get install libgeos-dev"
fi

# }}}

test -z "$missing_dep" || die "Missing dependencies, please upgrade your system"
